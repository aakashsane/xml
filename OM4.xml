<?xml version="1.0"?>
<!-- FRE Usage documentation: http://www.gfdl.noaa.gov/fms/fre -->
<!-- $Id: OM4.xml,v 1.1.2.12.2.6.2.3 2014/05/23 19:37:49 Niki.Zadeh Exp $ -->

<!--
Quick start guide

module load fre/bronx-9
fremake -x OM4.xml -p ncrc2.intel -t prod MOM6_SIS_libs_compile -no-link
   To run with SIS
fremake -x OM4.xml -p ncrc2.intel -t prod MOM6_SIS_compile
frerun  -x OM4.xml -p ncrc2.intel -t prod OM4_SIS_baseline -r basic 
   To run with SIS2
fremake -x OM4.xml -p ncrc2.intel -t prod MOM6_SIS2_compile
frerun  -x OM4.xml -p ncrc2.intel -t prod OM4_SIS2_baseline -r basic 


-->

<experimentSuite rtsVersion="4" xmlns:xi="http://www.w3.org/2001/XInclude">
   <property name="RELEASE"      value="ulm"/> <!-- CVS tag for shared source code -->
   <property name="MOM6_DATE"    value="2015.07.20"/>     <!-- git tag date for MOM6 source code -->
   <property name="FRE_STEM"     value="$(RELEASE)_mom6_$(MOM6_DATE)"/>
   <property name="MOM6_GIT_TAG" value="dev/master/$(MOM6_DATE)"/> <!-- git tag for MOM6 source code -->
   <property name="BERGS_GIT_TAG" value="dev/master"/>
   <property name="FRE_VERSION"  value="fre/bronx-10"/>

   <!--Production run properties. Users can modify these according to their need and/or performance analysis-->
   <property name="PROD_SIMTIME"   value="4"/>
   <!--Post-processing  chunk lengths -->
   <property name="CHUNK_LENGTH_A" value="5yr"/>
   <property name="CHUNK_LENGTH_B" value="20yr"/>

   <!--The following properties need to be set only if the user wants to monitor the run progress at MDBI
      and are not needed for the run or post-processing -->
   <property name="PP_START_YEAR"  value="1900"/>
   <property name="PP_END_YEAR"    value="1919"/>
   <property name="ANALYSIS_SWITCH" value="on"/>
   <property name="MDBIswitch"      value="on"/>  <!-- on/off switch for MDBI database -->


   <property name="PROD_RUNTIME"         value="16:00:00"/><!--zeus value="08:00:00"-->
   <property name="PROD_SEGTIME"         value="04:10:00"/><!--zeus value="02:10:00"-->
   <property name="PROD_NPES"            value="2997"/> 
<!-- Not used anymore
   <property name="MASK_TABLE"           value="mask_table.1053.90x45"/>
   <property name="OCN_PROD_LAYOUT"      value="90,45"/>
   <property name="OCN_PROD_IO_LAYOUT"   value="9,5"/>
   <property name="ICE_PROD_LAYOUT"      value="90,45"/>
   <property name="ICE_PROD_IO_LAYOUT"   value="9,5"/>
   <property name="LND_PROD_LAYOUT"      value="90,45"/>
   <property name="FV_PROD_LAYOUT"       value="90,45"/>
-->  


   <!--Users need not change the following properties -->
   <property name="reference_tag"  value="ulm_answers"/> <!-- Reference release tag for existing files in the archives for answer comparison. Used in "REFERENCE" property. -->
   <property name="PROG_MAIN"   value="coupler/coupler_main.o"/>
   <property name="LIBS_ROOT"   value="MOM6_SIS_libs_compile"/>
   <property name="FMS_LIB_DIR" value="./$(LIBS_ROOT)/$(platform)-$(target)/exec"/>

   <!-- The following properties are for testing/debugging purposes and should normally be empty-->
   <property name="MODIFIER"     value=""/>  
   <property name="DEBUGLEVEL"   value=""/>

   <setup>
    <platform name="ncrc2.intel">
      <project>gfdl_o</project>
      <directory stem="$(FRE_STEM)"/>
         <directory>
            <!--unswept locations-->
            <root>$CPERM/$USER/$(FRE_STEM)</root>
            <scripts>$CPERM/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)/scripts</scripts>
            <state>$CPERM/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)/state</state>
            <!--swept locations (including the staged archive location)-->
            <archive>$CTMP/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)</archive>
            <stdout>$CTMP/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)/stdout</stdout>
            <work>$CTMP/$USER/work/$(FRE_STEM)/$FRE_JOBID</work>
         </directory>
 
      <csh><![CDATA[
          source $MODULESHOME/init/csh
          module use -a /ncrc/home2/fms/local/modulefiles
          module unload PrgEnv-pgi PrgEnv-pathscale PrgEnv-intel PrgEnv-gnu PrgEnv-cray
          module unload netcdf fre fre-commands
          module load PrgEnv-intel
          module swap intel intel/12.0.5.220
          module load git
          module load $(FRE_VERSION)
          setenv KMP_STACKSIZE 512m
          setenv NC_BLKSZ 1M
          alias cpget 'cp \!^ \!^.copy ; \rm -f \!^ ; mv \!^.copy \!^ ; chmod +w \!^ '
     ]]></csh>

     <property name="MY_ROOT"          value="$(rootDir)"/>
     <property name="FMS_ARCHIVE_ROOT" value="$CDATA/fms"/>
     <property name="F2003_FLAGS"      value="-DINTERNAL_FILE_NML -g -traceback"/> <!-- -g -traceback -->
     <property name="REFERENCE"        value="/lustre/f1/unswept/Niki.Zadeh/$(reference_tag)/$(name)/$(platform)-$(target)"/>
     <property name="NB_ROOT"          value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/>
 
    </platform>

    <platform name="ncrc2.default">
      <xi:include xpointer="xpointer(//setup/platform[@name='ncrc2.intel']/node())" />
    </platform>

    <platform name="ncrc2.gnu">
      <project>gfdl_o</project>
      <directory stem="$(FRE_STEM)"/>
 
      <csh><![CDATA[
          source $MODULESHOME/init/csh
          module use -a /ncrc/home2/fms/local/modulefiles
          module unload PrgEnv-pgi PrgEnv-pathscale PrgEnv-intel PrgEnv-gnu PrgEnv-cray
          module unload netcdf fre fre-commands
          module load PrgEnv-gnu
          module load git
          module load $(FRE_VERSION)
          setenv KMP_STACKSIZE 512m
          setenv NC_BLKSZ 1M
          alias cpget 'cp \!^ \!^.copy ; \rm -f \!^ ; mv \!^.copy \!^ ; chmod +w \!^ '
          # MAIN_PROGRAM env is needed by the GNU compiler
          setenv MAIN_PROGRAM $(PROG_MAIN)
          module load git
     ]]></csh>

     <property name="MY_ROOT"          value="$(rootDir)"/>
     <property name="FMS_ARCHIVE_ROOT" value="$CDATA/fms"/>
     <property name="F2003_FLAGS"      value="-DINTERNAL_FILE_NML -fbacktrace "/> <!-- -g -traceback -->
     <property name="REFERENCE"        value="/lustre/f1/unswept/Niki.Zadeh/$(reference_tag)/$(name)/$(platform)-$(target)"/>
     <property name="NB_ROOT"          value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/>
 
    </platform>
    <platform name="nescc.intel">
      <project>gfdlport</project>
      <directory stem="$(FRE_STEM)">
        <root>/scratch2/portfolios/GFDL/gfdlscr/$USER/$(stem)</root>
        <src>/scratch2/portfolios/GFDL/gfdlscr/$USER/$(stem)/$(name)/src</src>
        <exec>/scratch2/portfolios/GFDL/gfdlscr/$USER/$(stem)/$(name)/$(platform)-$(target)/exec</exec>
        <scripts>$HOME/$(stem)/$(name)/$(platform)-$(target)/scripts</scripts>
        <stdout>/scratch2/portfolios/GFDL/gfdlscr/$USER/$(stem)/$(name)/$(platform)-$(target)/stdout</stdout>
        <state>$HOME/$(stem)/$(name)/$(platform)-$(target)/state</state>
        <work>/scratch2/portfolios/GFDL/gfdlscr/$USER/work/$FRE_JOBID</work>
        <ptmp>/scratch2/portfolios/GFDL/gfdlscr/$USER/ptmp</ptmp>
        <stmp>/scratch2/portfolios/GFDL/gfdlscr/$USER/stmp</stmp>
        <archive>/scratch2/portfolios/GFDL/gfdlscr/$USER/$(stem)/$(name)/$(platform)-$(target)</archive>
      </directory>
      <mkmfTemplate file="/home/Niki.Zadeh/fre/fre-commands/site/nescc/intel.mk"/>
      <property name="F2003_FLAGS"       value=" -DINTERNAL_FILE_NML"/>
      <property name="MY_ROOT"          value="$(rootDir)"/>
      <property name="NB_ROOT"           value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/>
      <property name="REFERENCE"         value=""/>
      <property name="ARCHIVE_INPUT_NZ"  value="/scratch2/portfolios/GFDL/gfdlscr/Niki.Zadeh/archive/input"/>

      <csh><![CDATA[
        module use ~fms/local/modulefiles
        #module load intel/12-12.0.4.191 #need more up-to-date compiler for ulm
        module load intel/13.0.079
        module load netcdf/4.1.1-intel-12
        module load mpt/2.06
        module load $(FRE_VERSION)
        module load nco
        setenv MPICH_CPUMASK_DISPLAY
        setenv KMP_STACKSIZE 512m
        setenv NC_BLKSZ 1M
        setenv F_UFMTENDIAN big
        setenv SMA_SHMALLOC_FORCE_EQUAL off
        setenv MPI_BUFS_PER_PROC 512
        setenv MPI_BUFS_PER_HOST 512
        setenv MPI_IB_TIMEOUT 20
      ]]></csh>
    </platform>

    <platform name="nescc.default">
      <xi:include xpointer="xpointer(//setup/platform[@name='nescc.intel']/node())" />
    </platform>

<!-- gfdl platforms -->

    <platform name="gfdl.default">
      <property name="NB_ROOT"  value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/><!--Do not change this! Other platforms use  the same value. -->
      <directory stem="$(FRE_STEM)">
        <archive>$ARCHIVE/$(stem)/$(name)/$(platform)-$(target)</archive>
        <postProcess>$(archiveDir)/pp</postProcess>
        <analysis>$(NB_ROOT)</analysis><!--Do not change this! frepp translates this to $out_dir. This is also the directory under which  frepp looks for mom6 clone.  -->
	<ptmp>/ptmp/$USER</ptmp>
      </directory>
      <property name="F2003_FLAGS"       value=" -DINTERNAL_FILE_NML"/>
      <property name="MY_ROOT"          value="$(rootDir)"/>
      <property name="REFERENCE"         value=""/>
      <property name="ARCHIVE_INPUT_NZ"  value=""/>

      <csh><![CDATA[
        source $MODULESHOME/init/csh
        module use -a /home/fms/local/modulefiles
        module purge
        module load $(FRE_VERSION)
        module load fre-analysis
        module load git
        setenv FREVERSION $(FRE_VERSION)           
        setenv NBROOT $(NB_ROOT)
        /home/Niki.Zadeh/nnz_tools/bin/verify -m $(MOM6_GIT_TAG) -x dev 
       ]]>
      </csh>
    </platform>

    <platform name="gfdl.ncrc2-default">
      <xi:include xpointer="xpointer(//setup/platform[@name='gfdl.default']/node())" />
    </platform>
    <platform name="gfdl.ncrc2-intel">
      <xi:include xpointer="xpointer(//setup/platform[@name='gfdl.default']/node())" />
    </platform>

    <platform name="gfdl.nescc-default">
      <xi:include xpointer="xpointer(//setup/platform[@name='gfdl.default']/node())" />
    </platform>
    <platform name="gfdl.nescc-intel">
      <xi:include xpointer="xpointer(//setup/platform[@name='gfdl.default']/node())" />
    </platform>

</setup>

   <property name="MOM6_EXAMPLES"  value="$root/$(LIBS_ROOT)/src/mom6"/>
   <property name="MY_LIBS"        value="$(MY_ROOT)/$(FMS_LIB_DIR)"/>

   <experiment name="MOM6_SIS_libs_compile">
      <description>
Make the executable for ocean-ice experiments.
      </description>
      <component name="fms" paths="shared" includeDir="$root/$(LIBS_ROOT)/src/shared/include">
         <description domainName="infrastructure" communityName="FMS" communityVersion="$(RELEASE)" communityGrid="NA"/>
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
            <codeBase version="$(RELEASE)"> shared.git </codeBase>
            <csh><![CDATA[
            ( cd shared && git checkout $(RELEASE) )
             ]]>
            </csh>
         </source>
         <compile>
            <cppDefs>-Duse_libMPI -Duse_netCDF $(F2003_FLAGS)</cppDefs>
         </compile>
      </component>

      <component paths="ocean_shared" requires="fms" name="ocean_shared">
      <description domainName="Ocean Generic Tracers" communityName="GFDL-ocean-shared" communityVersion="$(RELEASE)" communityGrid="Tripolar"/>
      <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
        <codeBase version="$(RELEASE)"> ocean_shared.git </codeBase>
        <csh><![CDATA[
        ( cd ocean_shared && git checkout $(RELEASE) )
        ( cd ocean_shared && git checkout user/nnz/verona_dev_merge )
        ]]>
        </csh>
      </source>
      <compile>
        <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]></cppDefs>
      </compile>
    </component>

      <component name="mom6" requires="fms ocean_shared" paths="mom6/src/MOM6/config_src/dynamic mom6/src/MOM6/config_src/coupled_driver mom6/src/MOM6/src/*/ mom6/src/MOM6/src/*/*/">
         <description domainName="Ocean" communityName="GFDL-MOM6" communityVersion="$(MOM6_GIT_TAG)" communityGrid="Tripolar"/>
         <source versionControl="git" root="http://github.com">
        <codeBase version="$(MOM6_GIT_TAG)"> NULL </codeBase>
        <csh>
          git clone -b $(MOM6_GIT_TAG) http://github.com/NOAA-GFDL/MOM6-examples.git mom6
          pushd mom6
          git checkout $(MOM6_GIT_TAG)  #needed for older git on zeus
          git submodule init src/MOM6 src/SIS2 tools/python/025gridGeneration/MIDAS
          git clone --recursive http://github.com/NOAA-GFDL/MOM6.git src/MOM6 
          git clone             http://github.com/NOAA-GFDL/SIS2.git src/SIS2
          git submodule update #This gets the right version of submodules
          popd

          pushd mom6
          set platform_domain = `perl -T -e "use Net::Domain(hostdomain) ; print hostdomain"`
          if ("${platform_domain}" == "zeus.fairmont.rdhpcs.noaa.gov") then
            ln -s /scratch2/portfolios/GFDL/gfdlscr/John.Krasting/pdata/gfdl_O/datasets/ .datasets
          else
            ln -s /lustre/f1/pdata/gfdl_O/datasets/ .datasets
          endif
          popd	  

          test -e mom6/.datasets
          if ($status != 0) then
            echo ""; echo "" ; echo "   WARNING:  .datasets link in MOM6 examples directory is invalid"; echo ""; echo ""
          endif
            </csh>
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_USE_GENERIC_TRACER -D_FILE_VERSION="'"`git-version-string $<`"'"]]> </cppDefs>
         </compile>
      </component>

      <component name="icebergs" paths="icebergs" requires="fms">
         <source versionControl="git" root="http://github.com/NOAA-GFDL">
            <codeBase version="$(BERGS_GIT_TAG)"> icebergs.git </codeBase>
         </source>
         <compile>
            <cppDefs><![CDATA[-D_FILE_VERSION="'"`git-version-string $<`"'"]]> </cppDefs>
         </compile>
         <description domainName="N/A" communityName="N/A" communityVersion="$(RELEASE)" communityGrid="N/A"/>
      </component>

      <component name="ice_sis" paths="ice_param ice_sis" requires="fms icebergs">
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
            <codeBase version="$(RELEASE)"> ice_sis.git ice_param.git </codeBase>
            <csh><![CDATA[
             ( cd ice_sis && git checkout user/nnz/use_gitlabbergs )
             ( \rm ice_sis/ice_bergs.F90 )
              ]]>
            </csh>
        </source>
         <compile>
            <cppDefs>$(F2003_FLAGS)</cppDefs>
         </compile>
         <!-- MDBI -->
         <description domainName="Sea Ice SIS" communityName="GFDL-SIS" communityVersion="$(RELEASE)" communityGrid="Tripolar"/>
      </component>

      <!--Since SIS2 needs ice_param there is a dependency that may damage the compile if both ice_sis and sis2 try to cvs co ice_params at the same time. We should put ice_param files under sis2 git 
-->
      <component name="sis2" paths="mom6/src/SIS2 ice_param" requires="fms mom6 icebergs" includeDir="$root/$(LIBS_ROOT)/src/mom6/src/MOM6/src/framework" > 
         <description domainName="Sea Ice SIS2" communityName="GFDL-SIS2" communityVersion="$(RELEASE)" communityGrid="Tripolar"/>
         <source>
	   <codeBase version="$(RELEASE)"> ice_param </codeBase> 
            <csh> \rm mom6/src/SIS2/ice_bergs.F90 </csh> 
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]>
            </cppDefs>
         </compile>
      </component>

      <component name="land_null" paths="land_null" requires="fms">
         <description domainName="NA" communityName="NA" communityVersion="NA" communityGrid="NA"/>
         <source>
            <codeBase version="$(RELEASE)"> land_null </codeBase>
         </source>
      </component>

      <component name="atmos_null" paths="atmos_null atmos_param/monin_obukhov atmos_param/diag_integral" requires="fms">
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
           <codeBase version="$(RELEASE)"> atmos_null.git atmos_param.git </codeBase>
         </source>
         <compile>
            <cppDefs>$(F2003_FLAGS) </cppDefs>
        </compile>
      </component>
   </experiment>

   <experiment name="MOM6_SIS_compile" inherit="MOM6_SIS_libs_compile">
      <component paths="shared" name="fms" includeDir="$root/$(LIBS_ROOT)/src/shared/include">
         <library path="$(MY_LIBS)/fms/libfms.a" headerDir="$(MY_LIBS)/fms"/>
      </component>
      <component name="land_null" paths="land_null" requires="fms">
         <library path="$(MY_LIBS)/land_null/libland_null.a" headerDir="$(MY_LIBS)/land_null"/>
      </component>
      <component name="atmos_null" paths="atmos_null atmos_param" requires="fms">
          <library path="$(MY_LIBS)/atmos_null/libatmos_null.a" headerDir="$(MY_LIBS)/atmos_null"/>
      </component>
      <component paths="ocean_shared" requires="fms" name="ocean_shared">
         <library path="$(MY_LIBS)/ocean_shared/libocean_shared.a" headerDir="$(MY_LIBS)/ocean_shared"/>
      </component> 
      <component paths="mom6" requires="fms ocean_shared" name="mom6">
         <library path="$(MY_LIBS)/mom6/libmom6.a" headerDir="$(MY_LIBS)/mom6"/>
      </component> 
      <component paths="icebergs" requires="fms" name="icebergs">
         <library path="$(MY_LIBS)/icebergs/libicebergs.a" headerDir="$(MY_LIBS)/icebergs"/>
      </component> 
      <component paths="ice_sis" requires="fms icebergs" name="ice_sis">
         <library path="$(MY_LIBS)/ice_sis/libice_sis.a" headerDir="$(MY_LIBS)/ice_sis"/>
      </component> 
      <component name="coupler" paths="coupler" requires="fms land_null atmos_null ice_sis mom6 ocean_shared icebergs">
         <description domainName="FMS Coupler" communityName="coupler" communityVersion="$(RELEASE)" communityGrid="NA"/> 
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
            <codeBase version="$(RELEASE)"> coupler.git </codeBase>
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]></cppDefs>
         </compile>
      </component>
   </experiment>

    <experiment name="MOM6_SIS2_compile" inherit="MOM6_SIS_libs_compile">
      <component paths="shared" name="fms" includeDir="$root/$(LIBS_ROOT)/src/shared/include">
         <library path="$(MY_LIBS)/fms/libfms.a" headerDir="$(MY_LIBS)/fms"/>
      </component>
      <component name="land_null" paths="land_null" requires="fms">
         <library path="$(MY_LIBS)/land_null/libland_null.a" headerDir="$(MY_LIBS)/land_null"/>
      </component>
      <component name="atmos_null" paths="atmos_null atmos_param" requires="fms">
          <library path="$(MY_LIBS)/atmos_null/libatmos_null.a" headerDir="$(MY_LIBS)/atmos_null"/>
      </component>
      <component paths="ocean_shared" requires="fms" name="ocean_shared">
         <library path="$(MY_LIBS)/ocean_shared/libocean_shared.a" headerDir="$(MY_LIBS)/ocean_shared"/>
      </component> 
      <component paths="mom6" requires="fms ocean_shared" name="mom6">
         <library path="$(MY_LIBS)/mom6/libmom6.a" headerDir="$(MY_LIBS)/mom6"/>
      </component> 
      <component paths="icebergs" requires="fms" name="icebergs">
         <library path="$(MY_LIBS)/icebergs/libicebergs.a" headerDir="$(MY_LIBS)/icebergs"/>
      </component> 
      <component paths="sis2" requires="fms icebergs" name="sis2">
         <library path="$(MY_LIBS)/sis2/libsis2.a" headerDir="$(MY_LIBS)/sis2"/>
      </component> 
      <component name="coupler" paths="coupler" requires="fms land_null atmos_null sis2 mom6 ocean_shared icebergs">
         <description domainName="FMS Coupler" communityName="coupler" communityVersion="$(RELEASE)" communityGrid="NA"/> 
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
            <codeBase version="$(RELEASE)"> coupler.git </codeBase>
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]></cppDefs>
         </compile>
      </component>
   </experiment>


<experiment name="OM4_SIS_baseline" inherit="MOM6_SIS_compile">
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z test case
</description>  
    <scenario 
      communityForcing="CORE"
      parentExperimentID="N/A" 
      parentExperimentRIP="N/A" 
      startTime="$(PP_START_YEAR)"
      endTime="$(PP_END_YEAR)" 
      branch_time="0.0">
    </scenario>
    <communityComment>
    For more information please refer to the
    &lt;a href="http://wiki.gfdl.noaa.gov/index.php/MOM6"&gt; MOM6 Wiki.  &lt;/a&gt;
    </communityComment>

     <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

      <!--MOM6 Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='OM4_data']/input/node())"/>
      <!--SIS Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='SIS_data']/input/node())"/>
      <!--OM4 gridSpec mosaic datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='OM4_grid']/input/node())"/>
      <!--CORE forcing datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='CORE_data']/input/node())"/>

      <dataFile label="namelist" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/input.nml</dataSource>
      </dataFile>
      <dataFile label="fieldTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/field_table</dataSource>
      </dataFile>


      <diagTable>
$name
$baseDate
      </diagTable>


      <namelist name="coupler_nml">
       months = $months,
       days   = $days,
       current_date = 1900,1,1,0,0,0,
       hours = 0
       minutes = 0
       seconds = 0
       calendar = 'NOLEAP',
       dt_cpld  = 3600,
       dt_atmos = 3600,
       do_atmos = .false.,
       do_land = .false.,
       do_ice = .true.,
       do_ocean = .true.,
       atmos_npes = 0,
       ocean_npes = 0,
       concurrent = .false.
       use_lag_fluxes=.false. 
     </namelist>

     <namelist name="fms_nml">
            clock_grain='ROUTINE'
            clock_flags='NONE'
            domains_stack_size = $domains_stack_size
            stack_size =0
      </namelist>
     <namelist name="fms_io_nml" >
         fms_netcdf_restart=.true.
         threading_read='multi'
         max_files_r = 200
         max_files_w = 200
         checksum_required = .false. ! This is needed to be able to restart the Ice under GNU. ref. Redmine issue 2000
     </namelist>

     <namelist name="atmos_model_nml" >
       layout=$fv_layout
       mask_table='INPUT/$ocn_mask_table'
     </namelist>
     <namelist name="land_model_nml" >
       layout=$land_layout
       mask_table='INPUT/$ocn_mask_table'
     </namelist>

   
   </input>

   <runtime>   
       <regression name="basic">
         <run days="10"   npes="$(PROD_NPES)"  runTimePerJob="01:30:00"/>
       </regression>
       <regression name="rts">
         <run days="5 5"  npes="$(PROD_NPES)"  runTimePerJob="01:30:00"/>
         <!--the following two should reproduce eachother but not the basic because basic uses mask_table-->
         <run days="2"  npes="2304"  runTimePerJob="00:30:00"/>
         <run days="1 1"  npes="2304"  runTimePerJob="00:30:00"/>
         <run days="2"  npes="1152"  runTimePerJob="00:30:00"/>
         <!--the following is for checking the timings or production run-->
         <run months="1"  npes="$(PROD_NPES)"  runTimePerJob="00:50:00"/>
       </regression>
       <regression name="timing">
         <run months="1"   npes="576"   runTimePerJob="01:50:00"/>
         <run months="1"   npes="1152"  runTimePerJob="00:50:00"/>
         <run months="1"   npes="2304"  runTimePerJob="00:50:00"/>
         <run months="1"   npes="3240"  runTimePerJob="00:50:00"/>
         <run months="1"   npes="2432"  runTimePerJob="00:50:00"/>
       </regression>
       <regression name="debug">
         <run days="1"   npes="512"  runTimePerJob="03:30:00"/>
       </regression>

      <production simTime="$(PROD_SIMTIME)" units="years" npes="$(PROD_NPES)" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="$(PROD_SEGTIME)"/>
       </production>

      <reference restart="$(REFERENCE)/1x0m10d_2997pe/restart/19000111.tar"/>

   </runtime>
    <postProcess>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_postprocess']/postProcess/node())"/>
    </postProcess>

  </experiment>

  <experiment name="OM4_domain_decomp">
    <input>
      <csh><![CDATA[
set domains_stack_size = "3097152"

if ( "$npes" == "288" ) then
  set fv_layout    =   "24,12"; set fv_io_layout    =  "1,4"
  set land_layout  =   "24,12"; set land_io_layout  =  "1,4"
  set ice_layout   =   "24,12"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "24,12"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set ocean_npes = "288"

else if ( "$npes" == "512" ) then
  set fv_layout    =   "32,16"; set fv_io_layout    =  "8,4"
  set land_layout  =   "32,16"; set land_io_layout  =  "8,4"
  set ice_layout   =   "32,16"; set ice_io_layout   =  "8,4"
  set ocn_layout   =   "0,0"  ; set ocn_io_layout   =  "1,1"; set ocn_mask_table = "MOM_mask_table"
  set ocean_npes = "512"

else if ( "$npes" == "576" ) then
  set fv_layout    =   "24,24"; set fv_io_layout    =  "1,4"
  set land_layout  =   "24,24"; set land_io_layout  =  "1,4"
  set ice_layout   =   "24,24"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "0,0"  ; set ocn_io_layout   =  "1,1"; set ocn_mask_table = "MOM_mask_table"
  set ocean_npes = "576"

else if ( "$npes" == "1152" ) then
  set fv_layout    =   "32,36"; set fv_io_layout    =  "1,4"
  set land_layout  =   "32,36"; set land_io_layout  =  "1,4"
  set ice_layout   =   "32,36"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "32,36"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes = "1152"
#npes= 1152  main_loop= 1085.141626  ATM= 47.583859  OCN= 1036.583676  SYPD= 2.1814

else if ( "$npes" == "2304" ) then
  set fv_layout    =   "32,72"; set fv_io_layout    =  "1,4"
  set land_layout  =   "32,72"; set land_io_layout  =  "1,4"
  set ice_layout   =   "32,72"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "32,72"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes = "2304"
#npes= 2304  main_loop= 603.878142  ATM= 37.217106  OCN= 565.590432  SYPD= 3.91987


else if ( "$npes" == "3240" ) then
  set fv_layout    =   "45,72"; set fv_io_layout    =  "1,4"
  set land_layout  =   "45,72"; set land_io_layout  =  "1,4"
  set ice_layout   =   "45,72"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "45,72"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes   = "3240"
#npes= 3240  main_loop= 464.708698  ATM= 39.759137  OCN= 423.801078  SYPD= 5.09378

else if ( "$npes" == "2432" ) then
  set fv_layout    =   "45,72"; set fv_io_layout    =  "1,4"
  set land_layout  =   "45,72"; set land_io_layout  =  "1,4"
  set ice_layout   =   "45,72"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "45,72"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "mask_table.808.45x72"
  set do_ocean = "true"
  set ocean_npes   = "2432"
#npes= 2432  main_loop= 458.382556  ATM= 33.484085  OCN= 423.827549  SYPD= 5.16408

else if ( "$npes" == "4050" ) then
  set fv_layout    =   "90,45"; set fv_io_layout    =  "9,5"
  set land_layout  =   "90,45"; set land_io_layout  =  "9,5"
  set ice_layout   =   "90,45"; set ice_io_layout   =  "9,5"
  set ocn_layout   =   "90,45"; set ocn_io_layout   =  "9,5"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes   = "4050"

else if ( "$npes" == "2997" ) then
  set fv_layout    =   "90,45"; set fv_io_layout    =  "9,5"
  set land_layout  =   "90,45"; set land_io_layout  =  "9,5"
  set ice_layout   =   "90,45"; set ice_io_layout   =  "9,5"
  set ocn_layout   =   "90,45"; set ocn_io_layout   =  "9,5"; set ocn_mask_table = "mask_table.1053.90x45"
  set do_ocean = "true"
  set ocean_npes   = "2997"
#npes= 2997  main_loop= 395.756260  ATM= 33.947977  OCN= 361.032958  SYPD= 5.98127

else
  if ( $echoOn ) unset echo
  echo "*ERROR*: npes == '$npes' is not supported in this xml."
  if ( $echoOn ) set echo
  exit 1
endif

cat > $work/INPUT/MOM_layout << LAYOUT_EOF
#override undef NIPROC
#override undef NJPROC
#override undef NIPROC_IO
#override undef NJPROC_IO
#override LAYOUT = $ocn_layout
#override IO_LAYOUT = $ocn_io_layout
MASKTABLE = $ocn_mask_table
LAYOUT_EOF

cat > $work/INPUT/SIS_layout << LAYOUT_EOF
#override undef NIPROC
#override undef NJPROC
#override undef NIPROC_IO
#override undef NJPROC_IO
#override LAYOUT = $ice_layout
#override IO_LAYOUT = $ice_io_layout
MASKTABLE = $ocn_mask_table
LAYOUT_EOF

# runCommand:
  alias runCommand "aprun -n $ocean_npes -d 1 ./$executable:t"
#
# Copy MOM6 input files needed for postprocessing  to GFDL (waiting for FRE to do this for us)
#
set platform_domain = `perl -T -e "use Net::Domain(hostdomain) ; print hostdomain"`
if ( $?flagOutputXferOn && $?flagOutputPostProcessOn ) then
  #trick to copy MOM6 directory but avoid traversing the .datasets links
  tar cvf mom6.tar --exclude='.datasets' -C $(MOM6_EXAMPLES) . > /dev/null
  #tar cvf mom6.tar  --exclude='.datasets' --exclude='src' --exclude='INPUT'  -C $(MOM6_EXAMPLES) . > /dev/null
  mkdir mom6
  tar xvf mom6.tar -C ./mom6 > /dev/null
  if ("${platform_domain}" == "ncrc.gov") then
    gcp --batch -cd -r --sync mom6 gfdl:$(NB_ROOT)/
  else if ("${platform_domain}" == "zeus.fairmont.rdhpcs.noaa.gov") then
    gcp -cd -r --sync mom6 gfdl:$(NB_ROOT)/
  endif
endif

      ]]></csh>

    </input>
  </experiment>

  <experiment name="OM4_grid">
    <input>
      <dataFile label="gridSpec" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/grid_spec.nc</dataSource>
        <dataSource site="gfdl">/archive/gold/datasets/OM4_025/mosaic.v20140610.unpacked/grid_spec.nc</dataSource> 
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/atmos_mosaic_tile1Xland_mosaic_tile1.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/atmos_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/land_mask.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/land_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/ocean_hgrid.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/ocean_mask.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/ocean_mosaic.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/ocean_topog.nc</dataSource>
       <!--hsmget cannot get this  <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/topog.nc</dataSource> -->
      </dataFile>
    </input>
  </experiment>

      <!--OM4 CORE forcing datasets-->
  <experiment name="CORE_data">
    <input>
      <dataFile label="dataTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/data_table</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/ncar_precip.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/ncar_rad.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/q_10_mod.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/runoff.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/salt_restore.v20140616.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/slp.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/t_10_mod.clim.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/u_10_mod.clim.nc</dataSource>
      </dataFile>      
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/v_10_mod.clim.nc</dataSource>
      </dataFile>

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/cfc.bc.nc</dataSource>
      </dataFile>

    </input>
  </experiment>
  
  <experiment name="OM4_data">
    <input>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/MOM_input</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/MOM_saltrestore</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/layer_coord.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/seawifs_1998-2006_smoothed_2X.v20140616.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/tidal_amplitude.v20140616.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/MOM_channels_global_025</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/vgrid_75_2m.nc</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/WOA05_pottemp_salt.nc </dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/mask_table.808.45x72</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/mask_table.1053.90x45</dataSource>
      </dataFile>      
      <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/diag_table.MOM6</dataSource>
        <dataSource site="nescc">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/diag_table.MOM6</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/ice_ocean_SIS/OM4_025/diag_table.MOM6</dataSource>
      </dataFile>

     <namelist name="MOM_input_nml" >
         output_directory = './',
         input_filename = '$restart_flag'
         restart_input_dir = 'INPUT/',
         restart_output_dir = 'RESTART/',
         parameter_filename = 'INPUT/MOM_input','INPUT/MOM_layout','INPUT/MOM_saltrestore','INPUT/MOM_override'
     </namelist>

     <csh type="always"><![CDATA[
if ( $currentSeg == 1 ) then
   set restart_flag = 'n'
else
   set restart_flag = 'r'
endif

ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc 

touch $work/INPUT/MOM_override
touch $work/INPUT/SIS_override

      ]]></csh>
 
     </input>

  </experiment>

  <experiment name="SIS_data">
    <input>

     <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/diag_table.SIS</dataSource>
        <dataSource site="nescc">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/diag_table.SIS</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/ice_ocean_SIS/OM4_025/diag_table.SIS</dataSource>
     </dataFile>

     <dataFile label="input" target="INPUT/ice_model.res.nc" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/.datasets/OM4_025/INPUT/ice_model.res.v20140620.nc</dataSource>
     </dataFile>
      
     <namelist name="ice_model_nml">
           layout = $ice_layout
           io_layout = $ice_io_layout
           mask_table='INPUT/$ocn_mask_table'
           nsteps_dyn=144
           nsteps_adv=2
           num_part = 6
           wd_turn = 0.0
           spec_ice=.false.
           ice_bulk_salin = 0.0
           alb_sno = 0.85                    ! keep CM2 setting
           alb_ice = 0.65                    ! keep CM2 setting
           t_range_melt = 1.0                ! NOTE: CM2 uses 1.0
           heat_rough_ice = 5.0e-4
           cm2_bugs = .false.
           do_icebergs = .false.
           add_diurnal_sw = .true.
           do_ice_limit=.false.
           max_ice_limit=4.0
           channel_viscosity=0.e5
           h_lo_lim = 1.e-10
      </namelist>

     </input>
  </experiment>

  <experiment name="SIS2_data">
    <input>

     <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS2/OM4_025/diag_table.SIS</dataSource>
        <dataSource site="nescc">$(MOM6_EXAMPLES)/ice_ocean_SIS2/OM4_025/diag_table.SIS</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/ice_ocean_SIS2/OM4_025/diag_table.SIS</dataSource>
     </dataFile>
     <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/OM4_025/SIS_input</dataSource>
     </dataFile>

<!-- No init ice yet
     <dataFile label="input" target="INPUT/ice_model.res.nc" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/OM4_025/INPUT/.datasets/OM4_025/INPUT/ice_model.res.v20140620.nc</dataSource>
     </dataFile>
-->
     <namelist name="SIS_input_nml" >
         output_directory = './',
         input_filename = '$restart_flag'
         restart_input_dir = 'INPUT/',
         restart_output_dir = 'RESTART/',
         parameter_filename = 'INPUT/SIS_input','INPUT/SIS_layout','INPUT/SIS_override'
     </namelist>

     </input>
  </experiment>

  <!-- OCEAN  and ICE post-processing-->
  <experiment name="OM4_postprocess">

      <postProcess> 
         <csh><![CDATA[
         cd $work/RESTART
	 #Treat icebergs restarts and trajectories
         #Find non-empty iceberg restarts and combine them AND then remove uncombined restarts
	 #This should be handled properly by FRE
         #ncrcat icebergs.res.nc.* icebergs.res.nc
	 set non_empty_restarts = ""
         foreach file ( `ls icebergs.res.nc.????` )
            if ( `ncdump -h $file | grep UNLIMITED | awk '{gsub(/\(/," ");print $6}'` ) set non_empty_restarts = "$non_empty_restarts $file"
         end
         ncrcat $non_empty_restarts icebergs.res.nc
         mkdir hide_from_fre
         mv icebergs.res.nc.* hide_from_fre/
         cd $work
         ncrcat iceberg_trajectories.nc.* iceberg_trajectories.nc
         mv iceberg_trajectories.nc.* hide_from_fre/
         #Save the last line of timestats without the first (step number) column as a signature of MOM6 answers
         tail -1 timestats | cut -c8- > RESTART/$enddate.timestats.res
         #Save the whole timestats under ascii/
         mv timestats $enddate.timestats
         mv timestats.nc $enddate.timestats.nc

         #Make a directory to trick FRE to pick up and archive in ascii
         mkdir extra.results
         mv *velocity_truncations MOM_parameter_doc* SIS_parameter_doc* seaice.stats timestats extra.results/

         ]]></csh>

      <!--REFINE DIAG SCRIP -->
      <!--By default a refineDiag script causes the annual data to be unpacked and saved in /ptmp/$USER-->
      <!--MOM6_refineDiag.csh is currently empty and is here only to cause the unpack annual history files in /ptmp-->
      <refineDiag script="$(NB_ROOT)/mom6/tools/analysis/MOM6_refineDiag.csh"/>
      <!--PostProcessing component models-->
      <component type="ocean_5daily"   start="$(PP_START_YEAR)" source="ocean_5daily" sourceGrid="ocean-tripolar">
        <timeSeries freq="120hr" chunkLength="$(CHUNK_LENGTH_A)" source="ocean_5daily"/>
        <timeSeries freq="120hr" chunkLength="$(CHUNK_LENGTH_B)" source="ocean_5daily"/>
      </component>
      <component type="ocean_monthly"   start="$(PP_START_YEAR)" source="ocean_month" sourceGrid="ocean-tripolar">
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_A)" source="ocean_month">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/ice_ocean_SIS/OM4_025/ocn_monthly.frepp"/>
        </timeSeries>
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_B)" source="ocean_month">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/ice_ocean_SIS/OM4_025/ocn_monthly.frepp"/>
        </timeSeries>
      </component>

      <component type="ocean_annual_z" start="$(PP_START_YEAR)" source="ocean_annual_z"  sourceGrid="ocean-tripolar">
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_A)">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/ice_ocean_SIS/OM4_025/ocn_annual_z.frepp"/>
        </timeAverage>
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_B)">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/ice_ocean_SIS/OM4_025/ocn_annual_z.frepp"/>
        </timeAverage>

        <timeSeries freq="annual"  chunkLength="$(CHUNK_LENGTH_B)" source="ocean_annual_z"/>
	
      </component>

      <component type="ocean_annual" start="$(PP_START_YEAR)"  source="ocean_annual"  sourceGrid="ocean-tripolar"> 
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_A)">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/ice_ocean_SIS/OM4_025/ocn_annual.frepp"/>
        </timeAverage>
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_B)">
          <analysis switch="$(ANALYSIS_SWITCH)" cumulative="no" script="$(NB_ROOT)/mom6/ice_ocean_SIS/OM4_025/ocn_annual.frepp"/>
        </timeAverage>
      </component>

      <component type="ice"  start="$(PP_START_YEAR)"  source="ice_month"  sourceGrid="ocean-tripolar">
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_A)"  source="ice_month">
	   <analysis switch="$(ANALYSIS_SWITCH)" script="$(NB_ROOT)/mom6/tools/analysis/Krasting-SeaIce.csh"/>
	</timeSeries>   
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_B)"  source="ice_month">
           <analysis switch="$(ANALYSIS_SWITCH)" script="$(NB_ROOT)/mom6/tools/analysis/Krasting-SeaIce.csh"/>
        </timeSeries>
        <timeAverage source="annual"  interval="$(CHUNK_LENGTH_A)"/>
        <timeAverage source="annual"  interval="$(CHUNK_LENGTH_B)"/>
      </component>

     </postProcess>

</experiment>

  <experiment name="OM4i_postprocess">

      <postProcess> 
         <csh><![CDATA[
         cd $work/RESTART
         #Treat icebergs restarts and trajectories
         #Find non-empty iceberg restarts and combine them AND then remove uncombined restarts
         #This should be handled properly by FRE
         #ncrcat icebergs.res.nc.* icebergs.res.nc
         set non_empty_restarts = ""
         foreach file ( `ls icebergs.res.nc.????` )
            if ( `ncdump -h $file | grep UNLIMITED | awk '{gsub(/\(/," ");print $6}'` ) set non_empty_restarts = "$non_empty_restarts $file"
         end
         ncrcat $non_empty_restarts icebergs.res.nc
         mkdir hide_from_fre
         mv icebergs.res.nc.* hide_from_fre/
         cd $work
         ncrcat iceberg_trajectories.nc.* iceberg_trajectories.nc
         mv iceberg_trajectories.nc.* hide_from_fre/
         #Save the last line of timestats without the first (step number) column as a signature of MOM6 answers
         tail -1 timestats | cut -c8- > RESTART/$enddate.timestats.res
         #Save the whole timestats under ascii/
         mv timestats $enddate.timestats
         mv timestats.nc $enddate.timestats.nc

         #Make a directory to trick FRE to pick up and archive in ascii
         mkdir extra.results
         mv *velocity_truncations MOM_parameter_doc* SIS_parameter_doc* seaice.stats timestats extra.results/

         ]]></csh>

      <!--REFINE DIAG SCRIP -->
      <!--By default a refineDiag script causes the annual data to be unpacked and saved in /ptmp/$USER-->
      <!--MOM6_refineDiag.csh is currently empty and is here only to cause the unpack annual history files in /ptmp-->
      <refineDiag script="$(NB_ROOT)/mom6/tools/analysis/MOM6_refineDiag.csh"/>
      <!--PostProcessing component models-->
      <component type="ocean_monthly"   start="$(PP_START_YEAR)" source="ocean_month" sourceGrid="ocean-tripolar">
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_A)" source="ocean_month">
        </timeSeries>
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_B)" source="ocean_month">
        </timeSeries>
      </component>

<!--Currently there are no ocean_annual source file for MOM6_GOLD_SIS
      <component type="ocean_annual" start="$(PP_START_YEAR)"  source="ocean_annual"  sourceGrid="ocean-tripolar"> 
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_A)">
        </timeAverage>
        <timeAverage source="annual" interval="$(CHUNK_LENGTH_B)">
        </timeAverage>
      </component>
-->
      <component type="ice"  start="$(PP_START_YEAR)"  source="ice_month"  sourceGrid="ocean-tripolar">
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_A)"  source="ice_month">
	   <analysis switch="$(ANALYSIS_SWITCH)" script="$(NB_ROOT)/mom6/tools/analysis/Krasting-SeaIce.csh"/>
	</timeSeries>   
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_B)"  source="ice_month">
           <analysis switch="$(ANALYSIS_SWITCH)" script="$(NB_ROOT)/mom6/tools/analysis/Krasting-SeaIce.csh"/>
        </timeSeries>
        <timeAverage source="annual"  interval="$(CHUNK_LENGTH_A)"/>
        <timeAverage source="annual"  interval="$(CHUNK_LENGTH_B)"/>
      </component>

     </postProcess>

</experiment>
<experiment name="OM4_SIS_baseline_TEST" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="TEST" communityModel="OM4_SIS_baseline_TEST $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
MOM6 wiki: http://wiki.gfdl.noaa.gov/index.php/MOM6
</description>
</experiment>

<experiment name="OM4_SIS2_baseline" inherit="MOM6_SIS2_compile">
    <description communityProject="OWG" communityModel="OM4_SIS2 $(FRE_STEM)" communityModelID="OWG_OM4_SIS2" communityExperimentName="$(name)" >
 global 1/4 degree z test case
    </description>  
    <scenario 
      communityForcing="CORE"
      parentExperimentID="N/A" 
      parentExperimentRIP="N/A" 
      startTime="$(PP_START_YEAR)"
      endTime="$(PP_END_YEAR)" 
      branch_time="0.0">
    </scenario>
    <communityComment>
    For more information please refer to the
    &lt;a href="http://wiki.gfdl.noaa.gov/index.php/MOM6"&gt; MOM6 Wiki.  &lt;/a&gt;
    </communityComment>

     <input>

      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

      <!--MOM6 Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='OM4_data']/input/node())"/>
      <!--SIS2 Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='SIS2_data']/input/node())"/>
      <!--OM4 gridSpec mosaic datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='OM4_grid']/input/node())"/>
      <!--CORE forcing datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='CORE_data']/input/node())"/>

     
     <dataFile label="namelist" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS2/OM4_025/input.nml</dataSource>
     </dataFile>
     <dataFile label="fieldTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS2/OM4_025/field_table</dataSource>
     </dataFile>
      
      <diagTable>
$name
$baseDate
      </diagTable>

      <namelist name="coupler_nml">
       months = $months,
       days   = $days,
       current_date = 1900,1,1,0,0,0,
       hours = 0
       minutes = 0
       seconds = 0
       calendar = 'NOLEAP',
       dt_cpld  = 3600,
       dt_atmos = 3600,
       do_atmos = .false.,
       do_land = .false.,
       do_ice = .true.,
       do_ocean = .true.,
       atmos_npes = 0,
       ocean_npes = 0,
       concurrent = .false.
       use_lag_fluxes=.false. 
     </namelist>


    <namelist name="fms_nml">
            clock_grain='ROUTINE'
            clock_flags='NONE'
            domains_stack_size = 8000000
            stack_size =0
      </namelist>
     <namelist name="fms_io_nml" >
         fms_netcdf_restart=.true.
         threading_read='multi'
         max_files_r = 200
         max_files_w = 200
         checksum_required = .false. ! This is needed to be able to restart the Ice under GNU. ref. Redmine issue 2000
     </namelist>

     <namelist name="atmos_model_nml" >
       layout=$fv_layout
       mask_table='INPUT/$ocn_mask_table'
     </namelist>
     <namelist name="land_model_nml" >
       layout=$land_layout
       mask_table='INPUT/$ocn_mask_table'
     </namelist>

   </input>

   <runtime>   
       <regression name="basic">
         <run days="10"   npes="$(PROD_NPES)"  runTimePerJob="01:30:00"/>
       </regression>
       <regression name="rts">
         <run days="5 5"  npes="$(PROD_NPES)"  runTimePerJob="01:30:00"/>
         <!--the following two should reproduce eachother but not the basic because basic uses mask_table-->
         <run days="2"  npes="2304"  runTimePerJob="00:30:00"/>
         <run days="2"  npes="1152"  runTimePerJob="00:30:00"/>
         <!--the following is for checking the timings or production run-->
         <run months="1"  npes="$(PROD_NPES)"  runTimePerJob="00:50:00"/>
       </regression>

       <regression name="debug">
         <run days="1"   npes="288"  runTimePerJob="01:30:00"/>
       </regression>
       <regression name="restart">
         <run days="10"   npes="4050"  runTimePerJob="01:30:00"/>
         <run days="5 5"   npes="4050"  runTimePerJob="01:30:00"/>
       </regression>

      <production simTime="$(PROD_SIMTIME)" units="years" npes="$(PROD_NPES)" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="$(PROD_SEGTIME)"/>
       </production>

      <reference restart="$(REFERENCE)/1x0m10d_2997pe/restart/19000111.tar"/>

   </runtime>

    <postProcess>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_postprocess']/postProcess/node())"/>
    </postProcess>


</experiment>

<experiment name="OM4_SIS2_DT1200" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/SIS_override << OVERRIDE_EOF
#override DT_ICE_DYNAMICS = 1200.0
OVERRIDE_EOF
     ]]></csh>
   </input>

</experiment>

<experiment name="OM4_SIS2_low_mixing3" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_KPP = False
#override ENERGETICS_SFC_PBL = True
#override MSTAR = 0.3
#override KD = 2.0E-6
#override FOX_KEMPER_ML_RESTRAT_COEF = 20.0
#override SMAG_LAP_CONST = 0.
#override AH_VEL_SCALE = 0.
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>


<experiment name="OM4_SIS2_EPBL" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_KPP = False
#override ENERGETICS_SFC_PBL = True
#override BT_USE_VISC_REM_U_UH0 = False
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS2_EPBL_mstar_1.5" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_KPP = False
#override ENERGETICS_SFC_PBL = True
#override MSTAR = 1.5
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS2_EPBL_mstar_10" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_KPP = False
#override ENERGETICS_SFC_PBL = True
#override MSTAR = 10.
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS2_EPBL_nstar_0.1" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_KPP = False
#override ENERGETICS_SFC_PBL = True
#override NSTAR = 0.1
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS2_EPBL_nstar_0.3" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_KPP = False
#override ENERGETICS_SFC_PBL = True
#override NSTAR = 0.3
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS2_EPBL_MtoT_0.1" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_KPP = False
#override ENERGETICS_SFC_PBL = True
#override MKE_TO_TKE_EFFIC = 0.1 
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS2_EPBL_TKEdecay_10" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_KPP = False
#override ENERGETICS_SFC_PBL = True
#override TKE_DECAY = 10.0 
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS2_EPBL_use_omega" inherit="OM4_SIS2_baseline">
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_KPP = False
#override ENERGETICS_SFC_PBL = True
#override ML_USE_OMEGA = True 
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>


<experiment name="OM4_SIS_noBG" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)">
 global 1/4 degree z  no background mixing , as in the CM2.5 
</description>
<!-- MDBI -->
   <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override HENYEY_IGW_BACKGROUND = False
#override KD = 1.0E-07
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_gust_0p01" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   GUST_CONST = 0.01
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override GUST_CONST = 0.01
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_gust_0p03" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   GUST_CONST = 0.03
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override GUST_CONST = 0.03
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_gust_0p1" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   GUST_CONST = 0.1  - really push the gustiness, 10x
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override GUST_CONST = 0.1
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KPP_linear" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z  KPP shape linear
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override KPP%NLT_SHAPE = "LINEAR"
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KHTH_200" inherit="OM4_SIS_baseline">
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   KHTH_200, RES SCALED KHTH=F, res coef = default
</description>

   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_VARIABLE_MIXING = False
#override RESOLN_SCALED_KHTH = False
THICKNESSDIFFUSE = True
THICKNESSDIFFUSE_FIRST = True
KHTH = 200.
#override KHTH_SLOPE_CFF = 0.
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KHTH_res7_200" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   KHTH_200, RES SCALED KHTH=F, res coef = 0.7101
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_VARIABLE_MIXING = False
THICKNESSDIFFUSE = True
THICKNESSDIFFUSE_FIRST = True
KHTH = 200.
#override KHTH_SLOPE_CFF = 0.
KH_RES_FN_POWER = 100
KH_RES_SCALE_COEF = 0.7101
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KHTH_res1_200" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z   KHTH_200, RES SCALED KHTH=F, res coef = 1.0
</description>
<!-- MDBI -->
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_VARIABLE_MIXING = False
THICKNESSDIFFUSE = True
THICKNESSDIFFUSE_FIRST = True
KHTH = 200.
#override KHTH_SLOPE_CFF = 0.
KH_RES_FN_POWER = 100
KH_RES_SCALE_COEF = 1.0
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>


<experiment name="OM4_SIS_restrat_test" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
MOM6 wiki: http://wiki.gfdl.noaa.gov/index.php/MOM6
</description>

   <input>
     
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh type="always">
        <![CDATA[
#===Have to repeat whatever is in the parent experiment===
if ( $currentSeg == 1 ) then
   set restart_flag = 'n'
else
   set restart_flag = 'r'
endif

ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc

touch $work/INPUT/MOM_override

cat > $work/INPUT/MOM_override << OVERRIDE_EOF
MIXEDLAYER_RESTRAT = True
FOX_KEMPER_ML_RESTRAT_COEF = 20.
OVERRIDE_EOF


#=========================================================
#Append to diag_table
#=======================
if ( $irun == 1 ) then
cat >> $work/diag_table << DIAG_EOF
#================
# Additional DIAGNOSTICS
#================
 "ocean_model", "MLD_restrat",      "MLD_restrat",      "ocean_month", "all", "mean", "none",2
 "ocean_model", "uml_restrat",      "uml_restrat",      "ocean_month", "all", "mean", "none",2
 "ocean_model", "vml_restrat",      "vml_restrat",      "ocean_month", "all", "mean", "none",2
 "ocean_model", "udml_restrat",     "udml_restrat",     "ocean_month", "all", "mean", "none",2
 "ocean_model", "vdml_restrat",     "vdml_restrat",     "ocean_month", "all", "mean", "none",2
 "ocean_model", "uhml",             "uhml",             "ocean_month", "all", "mean", "none",2
 "ocean_model", "vhml",             "vhml",             "ocean_month", "all", "mean", "none",2
 "ocean_model", "MLu_restrat_time", "MLu_restrat_time", "ocean_month", "all", "mean", "none",2
 "ocean_model", "MLv_restrat_time", "MLv_restrat_time", "ocean_month", "all", "mean", "none",2
DIAG_EOF

endif

       ]]>
      </csh>

   </input>
</experiment>

<!--use the "append" method to append to the diag_table. Works only with bronx-9 and later-->
<experiment name="OM4_SIS_restrat_test2" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
MOM6 wiki: http://wiki.gfdl.noaa.gov/index.php/MOM6
</description>

   <input>
     
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh type="always">
        <![CDATA[
#===Have to repeat whatever is in the parent experiment===
if ( $currentSeg == 1 ) then
   set restart_flag = 'n'
else
   set restart_flag = 'r'
endif

ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc

touch $work/INPUT/MOM_override

cat > $work/INPUT/MOM_override << OVERRIDE_EOF
MIXEDLAYER_RESTRAT = True
FOX_KEMPER_ML_RESTRAT_COEF = 20.
OVERRIDE_EOF
       ]]>
      </csh>


<diagTable order="append">
#================
# Additional DIAGNOSTICS
#================
 "ocean_model", "MLD_restrat",      "MLD_restrat",      "ocean_month", "all", "mean", "none",2
 "ocean_model", "uml_restrat",      "uml_restrat",      "ocean_month", "all", "mean", "none",2
 "ocean_model", "vml_restrat",      "vml_restrat",      "ocean_month", "all", "mean", "none",2
 "ocean_model", "udml_restrat",     "udml_restrat",     "ocean_month", "all", "mean", "none",2
 "ocean_model", "vdml_restrat",     "vdml_restrat",     "ocean_month", "all", "mean", "none",2
 "ocean_model", "uhml",             "uhml",             "ocean_month", "all", "mean", "none",2
 "ocean_model", "vhml",             "vhml",             "ocean_month", "all", "mean", "none",2
 "ocean_model", "MLu_restrat_time", "MLu_restrat_time", "ocean_month", "all", "mean", "none",2
 "ocean_model", "MLv_restrat_time", "MLv_restrat_time", "ocean_month", "all", "mean", "none",2
</diagTable>



   </input>
</experiment>

<experiment name="OM4_SIS_baseline_kppbf" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
Baseline with backscatter diagnostics and bugfix for KPP shear
</description>

   <input>
     
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh type="always">
        <![CDATA[
#===Have to repeat whatever is in the parent experiment===
if ( $currentSeg == 1 ) then
   set restart_flag = 'n'
else
   set restart_flag = 'r'
endif

ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc

touch $work/INPUT/MOM_override

#=========================================================
#Append to diag_table
#=======================
if ( $irun == 1 ) then
cat >> $work/diag_table << DIAG_EOF
#================
# Additional DIAGNOSTICS
#================
 "ocean_model", "Res_fn",   "Res_fn",   "ocean_annual", "all", "mean", "none",2
DIAG_EOF

endif

       ]]>
      </csh>
   </input>
   <runtime>   
      <production simTime="5" units="years" npes="$(PROD_NPES)" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="$(PROD_SEGTIME)"/>
      </production>
   </runtime>
</experiment>



<experiment name="MOM6_GOLD_SIS" inherit="MOM6_SIS_compile">
<description communityProject="OWG" communityModel="MOM6_GOLD_SIS $(FRE_STEM)" communityModelID="OWG_MOM6_GOLD_SIS" communityExperimentName="$(name)" >
 global 1 degree i test case
</description>                                               
<scenario 
      communityForcing="CORE"
      parentExperimentID="N/A" 
      parentExperimentRIP="N/A" 
      startTime="$(PP_START_YEAR)"
      endTime="$(PP_END_YEAR)" 
      branch_time="0.0">
</scenario>
<communityComment>
    For more information please refer to the
    &lt;a href="http://wiki.gfdl.noaa.gov/index.php/MOM6"&gt; MOM6 Wiki.  &lt;/a&gt;
</communityComment>
     <input>                                                 
     <dataFile label="namelist" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/input.nml</dataSource>
        <dataSource site="nescc">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/input.nml</dataSource>
     </dataFile>                                                                                   
     <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">                   
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/diag_table</dataSource>
        <dataSource site="nescc">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/diag_table</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/ice_ocean_SIS/GOLD_SIS/diag_table</dataSource>
     </dataFile>                                                                                    
     <dataFile label="fieldTable" target="INPUT/" chksum="" size="" timestamp="">                   
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/field_table</dataSource>
        <dataSource site="nescc">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/field_table</dataSource>
     </dataFile>                                                                                     
     <dataFile label="dataTable" target="INPUT/" chksum="" size="" timestamp="">                     
        <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/data_table</dataSource> 
     </dataFile>                                                                                     
     <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">                         
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/MOM_input</dataSource> 
     </dataFile>                                                                                       

      <!--gridSpec mosaic datasets-->
      <dataFile label="gridSpec" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/grid_spec.nc</dataSource>
        <dataSource site="nescc">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/grid_spec.nc</dataSource>
        <dataSource site="gfdl">/archive/gold/datasets/GOLD_SIS/riga/mosaic.unpacked/grid_spec.nc</dataSource> 
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/mosaic.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/atmos_hgrid.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/atmos_mosaic.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/atmos_mosaic_tile1Xland_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/atmos_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/land_hgrid.nc</dataSource>                           
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/land_mask.nc</dataSource>                            
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/land_mosaic.nc</dataSource>                          
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/land_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource> 
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/ocean_hgrid.nc</dataSource>                          
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/ocean_mask.nc</dataSource>                           
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/ocean_mosaic.nc</dataSource>                         
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/ocean_vgrid.nc</dataSource>                          
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/README</dataSource>                                  
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/topog.nc</dataSource>                                
      </dataFile>                                                                                                                        

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/31Layer_zgrid.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/cfc.bc.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/geothermal_heating_cm2g.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/gustiness_qscat.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/OM3_zgrid.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/seawifs_1998-2006_GOLD_smoothed_2X.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/sgs_h2.nc</dataSource>                            
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/tideamp.nc</dataSource>                           
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/tke_tidal_cm2p2.nc</dataSource>                   
      </dataFile>                                                                                                                     

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/ncar_precip_clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/ncar_rad_clim.nc</dataSource>   
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/q_10_mod.clim.nc</dataSource>   
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/runoff.nc</dataSource>          
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/salt_restore.nc</dataSource>    
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/slp.clim.nc</dataSource>        
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/sst_ice_clim.nc</dataSource>    
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/t_10_mod.clim.nc</dataSource>   
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/temp_restore.nc</dataSource>    
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/u_10_mod.clim.nc</dataSource>   
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/v_10_mod.clim.nc</dataSource>   
      </dataFile>                                                                                                   

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
	 <!--Are the following two IC files both needed?--> 
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/GOLD_IC.2010.11.15.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/GOLD_SIS_IC.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS/INPUT/ocmip2_cfc.res.nc</dataSource>
      </dataFile>                                                                                              

      <namelist name="coupler_nml">
       months = $months,           
       days   = $days,             
       current_date = 1900,1,1,0,0,0,
       hours = 0                     
       minutes = 0                   
       seconds = 0                   
       calendar = 'NOLEAP',          
       dt_cpld  = 7200,              
       dt_atmos = 7200,              
       do_atmos = .false.,           
       do_land = .false.,            
       do_ice = .true.,              
       do_ocean = .true.,            
       atmos_npes = 0,            
       ocean_npes = 0,               
       concurrent = .false.          
       use_lag_fluxes=.true.         
     </namelist>                     

     <namelist name="MOM_input_nml" >
         output_directory = './',
         input_filename = '$restart_flag'
         restart_input_dir = 'INPUT/',
         restart_output_dir = 'RESTART/',
         parameter_filename = 'INPUT/MOM_input','INPUT/MOM_override'
     </namelist>
     <namelist name="fms_io_nml" >
         fms_netcdf_restart=.true.
         threading_read='multi'
         checksum_required = .false. ! This is needed to be able to restart the Ice under GNU. ref. Redmine issue 2000
     </namelist>
     <namelist name="dummy_ocean_model_nml">
       ocean_layout = 0,0
       ocean_io_layout = 1,1
       ocean_mask_table='MOM_mask_table'
     </namelist>
     <namelist name="dummy_ice_model_nml">
       ice_layout = 0,0
       ice_io_layout = 1,1
       ice_mask_table='MOM_mask_table'
     </namelist>


     <csh type="always">
        <![CDATA[
#------------------------------------------
## Find out whether to restart.

if ( $currentSeg == 1 ) then
   set restart_flag = 'n'
else
   set restart_flag = 'r'
endif

ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc 

touch $work/INPUT/MOM_override
touch $work/INPUT/SIS_override

#scan auxiliary_nml
set OCN_MASK_TABLE = `awk '/ocean_mask_table/ {gsub(/=/," ");gsub(/,/," ");print $2}' $work/input.nml`
set OCN_LAYOUT     = `awk '/ocean_layout/     {gsub(/=/," ");           print $2,$3}' $work/input.nml`
set OCN_IO_LAYOUT  = `awk '/ocean_io_layout/  {gsub(/=/," ");           print $2,$3}' $work/input.nml`

cat > $work/INPUT/MOM_layout << MOM_LAYOUT_EOF
#override undef NIPROC_IO
#override undef NJPROC_IO
#override undef NIPROC
#override undef NJPROC
#override IO_LAYOUT = $OCN_IO_LAYOUT
#override LAYOUT    = $OCN_LAYOUT
#override MASKTABLE = $OCN_MASK_TABLE
MOM_LAYOUT_EOF

cd $work
## Run the model
#------------------------------------------
       ]]>
      </csh>

     <csh><![CDATA[
#
# Copy MOM6 input files needed for postprocessing  to GFDL (waiting for FRE to do this for us)
#
set platform_domain = `perl -T -e "use Net::Domain(hostdomain) ; print hostdomain"`
if ( $?flagOutputXferOn && $?flagOutputPostProcessOn ) then
  #trick to copy MOM6 directory but avoid traversing the .datasets links
  tar cvf mom6.tar --exclude='.datasets' -C $(MOM6_EXAMPLES) . > /dev/null
  #tar cvf mom6.tar  --exclude='.datasets' --exclude='src' --exclude='INPUT'  -C $(MOM6_EXAMPLES) . > /dev/null
  mkdir mom6
  tar xvf mom6.tar -C ./mom6 > /dev/null
  if ("${platform_domain}" == "ncrc.gov") then
    gcp --batch -cd -r --sync mom6 gfdl:$(NB_ROOT)/
  else if ("${platform_domain}" == "zeus.fairmont.rdhpcs.noaa.gov") then
    gcp -cd -r --sync mom6 gfdl:$(NB_ROOT)/
  endif
endif
      ]]></csh>

   </input>
   <runtime>
       <regression name="basic">
         <run days="20"    npes="32" overrideParams="ice_model_nml:layout=8,4"  runTimePerJob="00:30:00"/>
       </regression>
       <regression name="rts">
         <run days="10 10" npes="32" overrideParams="ice_model_nml:layout=8,4"  runTimePerJob="00:30:00"/>
         <run days="20"    npes="64" overrideParams="ice_model_nml:layout=16,4;ice_model_nml:io_layout=1,4" runTimePerJob="00:30:00"/>
         <run days="20"    npes="32" overrideParams="ice_model_nml:layout=2,16;ice_model_nml:io_layout=1,1" runTimePerJob="00:30:00"/>
         <run months="1"    npes="64" overrideParams="ice_model_nml:layout=16,4;ice_model_nml:io_layout=1,4" runTimePerJob="00:30:00"/>
       </regression>
       <regression name="debug">
         <run days="2"    npes="32" overrideParams="ice_model_nml:layout=8,4"  runTimePerJob="00:30:00"/>
       </regression>

       <production simTime="$(PROD_SIMTIME)" units="years" npes="128" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="02:00:00"/>
       </production>

       <reference restart="$(REFERENCE)/1x0m20d_32pe/restart/00010121.tar"/>
   </runtime>

    <postProcess>
      <xi:include xpointer="xpointer(//experiment[@name='OM4i_postprocess']/postProcess/node())"/>
    </postProcess>

</experiment>

<experiment name="MOM6_GOLD_SIS_generics" inherit="MOM6_GOLD_SIS">
   <input>
      <namelist name="coupler_nml">
       months = $months,
       days   = $days,
       current_date = 1970,1,1,0,0,0,
       hours = 0
       minutes = 0
       seconds = 0
       calendar = 'NOLEAP',
       dt_cpld  = 7200,
       dt_atmos = 7200,
       do_atmos = .false.,
       do_land = .false.,
       do_ice = .true.,
       do_ocean = .true.,
       atmos_npes = 0,
       ocean_npes = 0,
       concurrent = .false.
       use_lag_fluxes=.true.
     </namelist>
         <namelist name="generic_tracer_nml">
       do_generic_tracer=.true.
       do_generic_CFC=.true.
       do_generic_SF6=.true.
       do_generic_age=.true.
       do_generic_argon=.true.
       do_generic_COBALT=.false.
       do_generic_TOPAZ=.false.
         </namelist>

<!--Once we have the surface forcing file we can use it this way	 
      <dataTable order="append">
"ATM", "sf6_flux_pcair_atm","SF6","INPUT/sf6.bc.nc",.false., 1.0
	</dataTable>
-->

      <diagTable order="append">
#================
# Additional DIAGNOSTICS
#================
#
#==================
# GENERIC TRACERS
#==================
#
## tracer quantities
"generic_tracers",          1,  "days", 1, "days", "time",
"generic_cfc","cfc_11",     "cfc_11",     "generic_tracers","all",.true.,"none",2
"generic_cfc","cfc_12",     "cfc_12",     "generic_tracers","all",.true.,"none",2
"generic_cfc","cfc_11_stf", "cfc_11_stf", "generic_tracers","all",.true.,"none",2
"generic_cfc","cfc_12_stf", "cfc_12_stf", "generic_tracers","all",.true.,"none",2
"generic_sf6","sf6",        "sf6",        "generic_tracers","all",.true.,"none",2
"generic_sf6","sf6_stf",    "sf6_stf",    "generic_tracers","all",.true.,"none",2
"generic_age","age",        "age",        "generic_tracers","all",.true.,"none",2
"generic_age","age_stf",    "age_stf",    "generic_tracers","all",.true.,"none",2
"generic_argon","argon",    "argon",        "generic_tracers","all",.true.,"none",2
"generic_argon","argon_stf","argon_stf",    "generic_tracers","all",.true.,"none",2

      </diagTable>

      <fieldTable order="append">
#Source information for individual generic tracers
#Currently generic_cfc package is set to use this mechanism as a prototype.
#Currently the following lines are required but they do not do anything until MOM6 becomes ready to handle them.
"namelists","ocean_mod","generic_cfc"
cfc_11_src_file = INPUT/cfc.bc.nc
cfc_11_src_var_name = CFC_11
cfc_11_src_var_unit = ppt
# ppt to mol/kg
cfc_11_src_var_unit_conversion = 1.0e-12
cfc_11_src_var_record = 1
cfc_11_src_var_gridspec = NONE

cfc_12_src_file = INPUT/cfc.bc.nc
cfc_12_src_var_name = CFC_12
cfc_12_src_var_unit = ppt
# ppt to mol/kg
cfc_12_src_var_unit_conversion = 1.0e-12
cfc_12_src_var_record = 1
cfc_12_src_var_gridspec = NONE
/
      </fieldTable>

     <csh>
        <![CDATA[
#
# Copy MOM6 input files needed for postprocessing  to GFDL (waiting for FRE to do this for us)
#
set platform_domain = `perl -T -e "use Net::Domain(hostdomain) ; print hostdomain"`
if ( $?flagOutputXferOn && $?flagOutputPostProcessOn ) then
  #trick to copy MOM6 directory but avoid traversing the .datasets links
  tar cvf mom6.tar --exclude='.datasets' -C $(MOM6_EXAMPLES) . > /dev/null
  #tar cvf mom6.tar  --exclude='.datasets' --exclude='src' --exclude='INPUT'  -C $(MOM6_EXAMPLES) . > /dev/null
  mkdir mom6
  tar xvf mom6.tar -C ./mom6 > /dev/null
  if ("${platform_domain}" == "ncrc.gov") then
    gcp --batch -cd -r --sync mom6 gfdl:$(NB_ROOT)/
  else if ("${platform_domain}" == "zeus.fairmont.rdhpcs.noaa.gov") then
    gcp -cd -r --sync mom6 gfdl:$(NB_ROOT)/
  endif
endif

cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_OCMIP2_CFC = False
#override USE_IDEAL_AGE_TRACER = False
USE_generic_tracer = True
GENERIC_TRACER_IC_FILE = "MOM_GENERICS.res.nc"
OVERRIDE_EOF

#Add null CFC's to a restart file
cd $work/INPUT
ncap -O --script 'cfc_11 = ptemp * 0.0 ; cfc_12 = ptemp * 0.0 ; sf6 = ptemp * 0.0 ; age  = ptemp * 0.0 ; argon = ptemp * 0.0 ' GOLD_IC.2010.11.15.nc MOM_GENERICS.res.nc
#CFC is constant_init_tracer so the ice fluxes are not needed.
\rm ice_ocmip2_cfc.res.nc

     ]]></csh>

   </input>

</experiment>



<experiment name="OM4_SIS_non_aggr" inherit="OM4_SIS_baseline">
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z    perturbation
</description>
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
AGGREGATE_FW_FORCING = False
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KPP_min12m" inherit="OM4_SIS_baseline">
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z  perturbation 
</description>
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
AGGREGATE_FW_FORCING = False
#override KPP%MINIMUM_OBL_DEPTH = 12.
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KPP_min6m" inherit="OM4_SIS_baseline">
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z  perturbation 
</description>
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
AGGREGATE_FW_FORCING = False
#override KPP%MINIMUM_OBL_DEPTH = 6.
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KPP_min6m_lowdiff" inherit="OM4_SIS_baseline">
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z  perturbation 
</description>
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
AGGREGATE_FW_FORCING = False
#override KPP%MINIMUM_OBL_DEPTH = 6.
#override KD = 1.0E-05
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_KPP_min6m_lowdiff_strongMLE" inherit="OM4_SIS_baseline">
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" >
 global 1/4 degree z perturbation
</description>
   <input>
     <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
AGGREGATE_FW_FORCING = False
#override KPP%MINIMUM_OBL_DEPTH = 6.
#override KD = 1.0E-05
#override FOX_KEMPER_ML_RESTRAT_COEF = 20.0
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_DT_THERM_7200" inherit="OM4_SIS_baseline">
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)">
 global 1/4 degree z  with THERMO_SPANS_COUPLING
</description>

    <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

     <csh><![CDATA[
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
THERMO_SPANS_COUPLING = True
#override DT_THERM = 7200
#override DIABATIC_FIRST = False
OVERRIDE_EOF
     ]]></csh>
   </input>
</experiment>

<experiment name="OM4_SIS_COBALT" inherit="OM4_SIS_baseline">
   <input>

      <namelist name="coupler_nml">
       months = $months,
       days   = $days,
       current_date = 1970,1,1,0,0,0,
       hours = 0
       minutes = 0
       seconds = 0
       calendar = 'NOLEAP',
       dt_cpld  = 3600,
       dt_atmos = 3600,
       do_atmos = .false.,
       do_land = .false.,
       do_ice = .true.,
       do_ocean = .true.,
       atmos_npes = 0,
       ocean_npes = 0,
       concurrent = .false.
       use_lag_fluxes=.true.
     </namelist>
       <namelist name="generic_tracer_nml">
       do_generic_tracer=.true.
       do_generic_CFC=.true.
       do_generic_COBALT=.true.
       do_generic_TOPAZ=.false.
         </namelist>
         <namelist name="diag_manager_nml">
       max_axes = 100,
       max_num_axis_sets = 100,
       max_input_fields = 699
       max_output_fields = 699
       mix_snapshot_average_fields=.false.
         </namelist>
         <namelist name="fms_nml">
            clock_grain='ROUTINE'
            clock_flags='NONE'
            domains_stack_size = 7000000
            stack_size =0
         </namelist>

      <fieldTable>
# specific humidity for moist runs
 "TRACER", "atmos_mod", "sphum" 
           "longname",     "specific humidity"
           "units",        "kg/kg" /
##	   "profile_type", "fixed", "surface_value=3.e-6" /
# prognostic cloud scheme tracers
  "TRACER", "atmos_mod", "liq_wat"
            "longname",     "cloud liquid specific humidity"
            "units",        "kg/kg" /
  "TRACER", "atmos_mod", "ice_wat"
            "longname",     "cloud ice water specific humidity"
            "units",        "kg/kg" /
  "TRACER", "atmos_mod", "cld_amt"
            "longname",     "cloud fraction"
            "units",        "none" /
# sphum must be present on land as well
 "TRACER", "land_mod",     "sphum"
           "longname",     "specific humidity"
           "units",        "kg/kg" /

"namelists","ocean_mod","generic_cobalt/*global*"
/

"namelists","ocean_mod","generic_cobalt"
init = f
/

#Currently generic_cfc package is set to use this mechanism as a prototype.
#Currently the following lines are required but they do not do anything until MOM6 becomes ready to handle them.
"namelists","ocean_mod","generic_cfc"
cfc_11_src_file = INPUT/cfc.bc.nc
cfc_11_src_var_name = CFC_11
cfc_11_src_var_unit = ppt
# ppt to mol/kg
cfc_11_src_var_unit_conversion = 1.0e-12
cfc_11_src_var_record = 1
cfc_11_src_var_gridspec = NONE

cfc_12_src_file = INPUT/cfc.bc.nc
cfc_12_src_var_name = CFC_12
cfc_12_src_var_unit = ppt
# ppt to mol/kg
cfc_12_src_var_unit_conversion = 1.0e-12
cfc_12_src_var_record = 1
cfc_12_src_var_gridspec = NONE
/

      </fieldTable>

      <dataTable order="append">
"ATM", "cfc_11_flux_pcair_atm","CFC_11","INPUT/cfc.bc.nc","bilinear", 1.0e-12
"ATM", "cfc_12_flux_pcair_atm","CFC_12","INPUT/cfc.bc.nc","bilinear", 1.0e-12
      </dataTable>

      
      <diagTable order="append">
#================
# Additional DIAGNOSTICS
#================
#
#==================
# GENERIC TRACERS
#==================
#
## tracer quantities
"generic_tracers",          1,  "days", 1, "days", "time",
"generic_cfc","cfc_11",     "cfc_11",     "generic_tracers","all",.true.,"none",2
"generic_cfc","cfc_12",     "cfc_12",     "generic_tracers","all",.true.,"none",2
"generic_cfc","cfc_11_stf", "cfc_11_stf", "generic_tracers","all",.true.,"none",2
"generic_cfc","cfc_12_stf", "cfc_12_stf", "generic_tracers","all",.true.,"none",2
      </diagTable>

      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>
     
     <csh type="always"><![CDATA[
if ( $currentSeg == 1 ) then
   set restart_flag = 'n'
else
   set restart_flag = 'r'
endif
ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc

#The keywod _NULL_ in the name of GENERIC_TRACER_IC_FILE cause the initialization from file to bypass
#hence there is no need to supply an artificial IC full of zeros. 
#The generic tracer package is responsible to initialize the tracers with proper values

cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_OCMIP2_CFC = False
USE_generic_tracer = True
GENERIC_TRACER_IC_FILE = "MOM_GENERICS_NULL_"
OVERRIDE_EOF

     ]]></csh>

   </input>
     
</experiment>

<experiment name="OM4_SIS_COBALT_DT_THERM_7200" inherit="OM4_SIS_COBALT">
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)">
 global 1/4 degree z  with THERMO_SPANS_COUPLING
</description>

    <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

       <csh type="always"><![CDATA[
if ( $currentSeg == 1 ) then
   set restart_flag = 'n'
else
   set restart_flag = 'r'
endif
ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc

cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override USE_OCMIP2_CFC = False
USE_generic_tracer = True
GENERIC_TRACER_IC_FILE = "MOM_GENERICS_NULL_"
THERMO_SPANS_COUPLING = True
#override DT_THERM = 7200
#override DIABATIC_FIRST = False
OVERRIDE_EOF


     ]]></csh>
   </input>
</experiment>
<experiment name="MOM6_GOLD_SIS2_bergs" inherit="MOM6_SIS2_compile">
<description communityProject="OWG" communityModel="MOM6_GOLD_SIS2 $(FRE_STEM)" communityModelID="OWG_MOM6_GOLD_SIS2" communityExperimentName="$(name)" >
 global 1 degree i test case
</description>                                               
<scenario 
      communityForcing="CORE"
      parentExperimentID="N/A" 
      parentExperimentRIP="N/A" 
      startTime="$(PP_START_YEAR)"
      endTime="$(PP_END_YEAR)" 
      branch_time="0.0">
</scenario>
<communityComment>
    For more information please refer to the
    &lt;a href="http://wiki.gfdl.noaa.gov/index.php/MOM6"&gt; MOM6 Wiki.  &lt;/a&gt;
</communityComment>
     <input>                                                 
     <dataFile label="namelist" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/input.nml</dataSource>
     </dataFile>                                                                                   
     <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">                   
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/diag_table</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/ice_ocean_SIS2/SIS2_icebergs/diag_table</dataSource>
     </dataFile>                                                                                    
     <dataFile label="fieldTable" target="INPUT/" chksum="" size="" timestamp="">                   
        <dataSource site="ncrc">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/field_table</dataSource>
     </dataFile>                                                                                     
     <dataFile label="dataTable" target="INPUT/" chksum="" size="" timestamp="">                     
        <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/data_table</dataSource> 
     </dataFile>                                                                                     
     <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">                         
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS/GOLD_SIS_icebergs/MOM_input</dataSource> 
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/MOM_override</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/SIS_input</dataSource> 
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/SIS_override</dataSource>
     </dataFile>      
                                                                             
      <!--gridSpec mosaic datasets-->
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/mosaic.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/grid_spec.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/atmos_hgrid.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/atmos_mosaic.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/atmos_mosaic_tile1Xland_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/atmos_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/land_hgrid.nc</dataSource>                           
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/land_mask.nc</dataSource>                            
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/land_mosaic.nc</dataSource>                          
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/land_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource> 
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/ocean_hgrid.nc</dataSource>                          
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/ocean_mask.nc</dataSource>                           
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/ocean_mosaic.nc</dataSource>                         
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/ocean_vgrid.nc</dataSource>                          
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/README</dataSource>                                  
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/topog.nc</dataSource>                                
      </dataFile>                                                                                                                        

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/cfc.bc.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/geothermal_heating_cm2g.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/gustiness_qscat.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/OM3_zgrid.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/seawifs_1998-2006_GOLD_smoothed_2X.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/sgs_h2.nc</dataSource>                            
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/tideamp.nc</dataSource>                           
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/tke_tidal_cm2p2.nc</dataSource>                   
      </dataFile>                                                                                                                     

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/ncar_precip_clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/ncar_rad_clim.nc</dataSource>   
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/q_10_mod.clim.nc</dataSource>   
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/runoff.nc</dataSource>          
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/salt_restore.nc</dataSource>    
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/slp.clim.nc</dataSource>        
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/sst_ice_clim.nc</dataSource>    
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/t_10_mod.clim.nc</dataSource>   
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/u_10_mod.clim.nc</dataSource>   
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/v_10_mod.clim.nc</dataSource>   
      </dataFile>                                                                                                   

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/GOLD_IC.2010.11.15.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/ocmip2_cfc.res.nc</dataSource>
      </dataFile>                                                                                              

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/31Layer_zgrid.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/example_calving.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/temp_restore.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_EXAMPLES)/ice_ocean_SIS2/SIS2_icebergs/INPUT/GOLD_SIS_IC.nc</dataSource>
      </dataFile>

      <namelist name="coupler_nml">
       months = $months,           
       days   = $days,             
       current_date = 1,1,1,0,0,0,
       hours = 0                     
       minutes = 0                   
       seconds = 0                   
       calendar = 'NOLEAP',          
       dt_cpld  = 7200,              
       dt_atmos = 7200,              
       do_atmos = .false.,           
       do_land = .false.,            
       do_ice = .true.,              
       do_ocean = .true.,            
       atmos_npes = 0,            
       ocean_npes = 0,               
       concurrent = .false.          
       use_lag_fluxes=.true.         
     </namelist>                     

     <namelist name="MOM_input_nml" >
         output_directory = './',
         input_filename = '$restart_flag'
         restart_input_dir = 'INPUT/',
         restart_output_dir = 'RESTART/',
         parameter_filename = 'INPUT/MOM_input','INPUT/MOM_layout','INPUT/MOM_override'  
     </namelist>

     <namelist name="SIS_input_nml" >
        output_directory = './',
        input_filename = '$restart_flag'
        restart_input_dir = 'INPUT/',
        restart_output_dir = 'RESTART/',
        parameter_filename = 'INPUT/SIS_input','INPUT/SIS_layout','INPUT/SIS_override' 
     </namelist>

     <namelist name="fms_io_nml" >
         fms_netcdf_restart=.true.
         threading_read='multi'
         checksum_required = .false. ! This is needed to be able to restart the Ice under GNU. ref. Redmine issue 2000
     </namelist>
 
     <namelist name="icebergs_nml">
    verbose=.false.,
    verbose_hrs=24,
    traj_sample_hrs=24,
    debug=.false.,
    really_debug=.false.,
    use_slow_find=.true.,
    add_weight_to_ocean=.true.,
    passive_mode=.false.,
    generate_test_icebergs=.false.,
    speed_limit=0.,
    use_roundoff_fix=.true.,
    make_calving_reproduce=.true.,
force_all_pes_traj = .true.
     </namelist>

     <namelist name="dummy_ocean_model_nml">
       ocean_layout = 8,16
       ocean_io_layout = 4,4
       ocean_mask_table='MOM_mask_table'
     </namelist>
     <namelist name="dummy_ice_model_nml">
       ice_layout = 8,16
       ice_io_layout = 4,4
       ice_mask_table='MOM_mask_table'
     </namelist>


     <csh type="always">
        <![CDATA[
#------------------------------------------
## Find out whether to restart.

if ( $currentSeg == 1 ) then
   set restart_flag = 'n'
else
   set restart_flag = 'r'
endif

ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc 

touch $work/INPUT/MOM_override
touch $work/INPUT/SIS_override

#scan auxiliary_nml
set OCN_MASK_TABLE = `awk '/ocean_mask_table/ {gsub(/=/," ");gsub(/,/," ");print $2}' $work/input.nml`
set OCN_LAYOUT     = `awk '/ocean_layout/     {gsub(/=/," ");           print $2,$3}' $work/input.nml`
set OCN_IO_LAYOUT  = `awk '/ocean_io_layout/  {gsub(/=/," ");           print $2,$3}' $work/input.nml`

cat > $work/INPUT/MOM_layout << MOM_LAYOUT_EOF
#override undef NIPROC_IO
#override undef NJPROC_IO
#override undef NIPROC
#override undef NJPROC
#override IO_LAYOUT = $OCN_IO_LAYOUT
#override LAYOUT    = $OCN_LAYOUT
#override MASKTABLE = $OCN_MASK_TABLE
MOM_LAYOUT_EOF

#scan auxiliary_nml
set ICE_MASK_TABLE = `awk '/ice_mask_table/ {gsub(/=/," ");gsub(/,/," ");print $2}' $work/input.nml`
set ICE_LAYOUT     = `awk '/ice_layout/     {gsub(/=/," ");           print $2,$3}' $work/input.nml`
set ICE_IO_LAYOUT  = `awk '/ice_io_layout/  {gsub(/=/," ");           print $2,$3}' $work/input.nml`

cat > $work/INPUT/SIS_layout << SIS_LAYOUT_EOF
#override undef NIPROC_IO
#override undef NJPROC_IO
#override undef NIPROC
#override undef NJPROC
#override IO_LAYOUT = $ICE_IO_LAYOUT
#override LAYOUT    = $ICE_LAYOUT
#override MASKTABLE = $ICE_MASK_TABLE
SIS_LAYOUT_EOF

cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override MSTAR = 0.3
OVERRIDE_EOF



cd $work
## Run the model
#------------------------------------------
       ]]>
      </csh>

     <csh><![CDATA[
#
# Copy MOM6 input files needed for postprocessing  to GFDL (waiting for FRE to do this for us)
#
set platform_domain = `perl -T -e "use Net::Domain(hostdomain) ; print hostdomain"`
if ( $?flagOutputXferOn && $?flagOutputPostProcessOn ) then
  #trick to copy MOM6 directory but avoid traversing the .datasets links
  tar cvf mom6.tar --exclude='.datasets' -C $(MOM6_EXAMPLES) . > /dev/null
  #tar cvf mom6.tar  --exclude='.datasets' --exclude='src' --exclude='INPUT'  -C $(MOM6_EXAMPLES) . > /dev/null
  mkdir mom6
  tar xvf mom6.tar -C ./mom6 > /dev/null
  if ("${platform_domain}" == "ncrc.gov") then
    gcp --batch -cd -r --sync mom6 gfdl:$(NB_ROOT)/
  else if ("${platform_domain}" == "zeus.fairmont.rdhpcs.noaa.gov") then
    gcp -cd -r --sync mom6 gfdl:$(NB_ROOT)/
  endif
endif
      ]]></csh>

   </input>
   <runtime>
       <regression name="basic">
         <run days="20"    npes="64" overrideParams="dummy_ocean_model_nml:ocean_layout=4,16;dummy_ocean_model_nml:ocean_io_layout=1,4;dummy_ice_model_nml:ice_layout=4,16;dummy_ice_model_nml:ice_io_layout=1,4" runTimePerJob="00:30:00"/>
       </regression>
       <regression name="rts">
         <run days="10 10" npes="64" overrideParams="dummy_ocean_model_nml:ocean_layout=4,16;dummy_ocean_model_nml:ocean_io_layout=1,4;dummy_ice_model_nml:ice_layout=4,16;dummy_ice_model_nml:ice_io_layout=1,4" runTimePerJob="00:30:00"/>
         <run days="20"    npes="32" overrideParams="dummy_ocean_model_nml:ocean_layout=4,8;dummy_ocean_model_nml:ocean_io_layout=1,4;dummy_ice_model_nml:ice_layout=4,8;dummy_ice_model_nml:ice_io_layout=1,4" runTimePerJob="00:30:00"/>
       </regression>

       <regression name="debug">
         <run days="2"    npes="64" overrideParams="dummy_ocean_model_nml:ocean_layout=4,16;dummy_ocean_model_nml:ocean_io_layout=1,4;dummy_ice_model_nml:ice_layout=4,16;dummy_ice_model_nml:ice_io_layout=1,4" runTimePerJob="00:30:00"/>
       </regression>

       <production simTime="$(PROD_SIMTIME)" units="years" npes="128" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="02:00:00"/>
       </production>

       <reference restart="$(REFERENCE)/1x0m20d_64pe/restart/00010121.tar"/>
   </runtime>

    <postProcess>
      <xi:include xpointer="xpointer(//experiment[@name='OM4i_postprocess']/postProcess/node())"/>
    </postProcess>

</experiment>



</experimentSuite>
